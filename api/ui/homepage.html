<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decimal Input Form</title>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
      let pointsChart; // Global variable to hold the chart instance

      function sendPostRequest() {
        const decimalValue = document.getElementById("decimalInput").value;
        const pointTypeID = document.getElementById("pointTypeDropdown").value;
        const userID = document.getElementById("userDropdown").value; // Get selected user ID

        const data = {
          userID: userID, // Add user ID to the data
          pointTypeID: pointTypeID,
          value: Number(decimalValue),
        };

        fetch("/api/points", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
            fetchPointsData();
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function populateDropdown() {
        fetch("/api/point_types")
          .then((response) => response.json())
          .then((data) => {
            const dropdown = document.getElementById("pointTypeDropdown");
            dropdown.innerHTML = ""; // Clear existing options

            data.forEach((point) => {
              const option = document.createElement("option");
              option.value = point.id;
              option.textContent = point.name;
              dropdown.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function populateUserDropdown() {
        fetch("/api/users")
          .then((response) => response.json())
          .then((data) => {
            const userDropdown = document.getElementById("userDropdown");
            userDropdown.innerHTML = ""; // Clear existing options

            data.forEach((user) => {
              const option = document.createElement("option");
              option.value = user.id;
              option.textContent = user.name;
              userDropdown.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function fetchPointsData() {
        fetch("/api/points")
          .then((response) => response.json())
          .then((data) => {
            populateTable(data);
            updateChart(data);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function fetchUserData() {
        fetch("/api/users/me")
          .then((response) => response.json())
          .then((data) => {
            const userInfo = document.getElementById("userInfo");
            userInfo.textContent = `Logged in as ${data.name}`;
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function populateTable(data) {
        const table = document.getElementById("pointsTable");
        table.innerHTML = ""; // Clear existing table data

        const header = `
                <tr>
                    <th>Timestamp</th>
                    <th>Value</th>
                    <th>Point Type Name</th>
                    <th>Created By User Name</th> <!-- New column for Created By User Name -->
                </tr>
            `;
        table.insertAdjacentHTML("beforeend", header);

        data.forEach((point) => {
          const row = `
                    <tr>
                        <td>${new Date(point.timestamp).toLocaleString()}</td>
                        <td>${point.value}</td>
                        <td>${point.pointTypeName}</td>
                        <td>${point.createdByUserName}</td> <!-- Display Created By User Name -->
                    </tr>
                `;
          table.insertAdjacentHTML("beforeend", row);
        });
      }

      function updateChart(data) {
        const ctx = document.getElementById("pointsChart").getContext("2d");
        const uniquePointTypeIDs = [
          ...new Set(data.map((point) => point.pointTypeID)),
        ];

        const chartData = uniquePointTypeIDs.map((id) => {
          return {
            label: data.find((point) => point.pointTypeID === id).pointTypeName,
            data: data
              .filter((point) => point.pointTypeID === id)
              .map((point) => ({
                x: new Date(point.timestamp),
                y: point.value,
              })),
            borderColor: getRandomColor(),
            fill: false,
            tension: 0.1,
          };
        });

        if (pointsChart) {
          pointsChart.destroy();
        }

        pointsChart = new Chart(ctx, {
          type: "line",
          data: {
            datasets: chartData,
          },
          options: {
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "hour",
                },
                title: {
                  display: true,
                  text: "Timestamp",
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Value",
                },
              },
            },
          },
        });
      }

      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      window.onload = () => {
        fetchUserData(); // Fetch logged-in user info
        populateUserDropdown(); // Populate user dropdown on page load
        populateDropdown();
        fetchPointsData();
      };
    </script>
  </head>

  <body>
    <div class="container my-5">
      <div class="d-flex justify-content-end mb-4">
        <span id="userInfo" style="color: black; font-size: small"></span>
      </div>

      <h1 class="mb-4 text-center">Enter a Decimal Number</h1>

      <!-- New User Dropdown -->
      <div class="mb-3">
        <label for="userDropdown" class="form-label">Select User:</label>
        <select
          id="userDropdown"
          name="userDropdown"
          class="form-select"
          required
        >
          <!-- Options will be populated here -->
        </select>
      </div>

      <form onsubmit="event.preventDefault(); sendPostRequest();" class="mb-4">
        <div class="mb-3">
          <label for="pointTypeDropdown" class="form-label"
            >Select Point Type:</label
          >
          <select
            id="pointTypeDropdown"
            name="pointTypeDropdown"
            class="form-select"
            required
          >
            <!-- Options will be populated here -->
          </select>
        </div>

        <div class="mb-3">
          <label for="decimalInput" class="form-label">Decimal Number:</label>
          <input
            type="text"
            id="decimalInput"
            name="decimalInput"
            pattern="[0-9]*\.?[0-9]+"
            class="form-control"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>

      <div class="mb-4">
        <canvas id="pointsChart" class="w-100"></canvas>
      </div>

      <div class="table-responsive">
        <table id="pointsTable" class="table table-bordered table-striped">
          <!-- Table data will be populated here -->
        </table>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
