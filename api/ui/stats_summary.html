<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Stats Summary</title>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <style>
      .expand-btn {
        cursor: pointer;
        color: #007bff;
        text-decoration: none;
      }

      .expand-btn:hover {
        text-decoration: underline;
      }

      .user-stats-table {
        margin-top: 20px;
      }

      /* Align user details more elegantly */
      .user-details {
        margin-top: 20px;
        border-top: 1px solid #dee2e6;
        padding-top: 20px;
      }

      .stats-summary {
        margin-top: 10px;
      }

      /* Points section emphasis */
      .points-section {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 5px;
        color: #007bff;
      }

      /* Compact stats section */
      .stats-summary p {
        margin-bottom: 2px;
        font-size: 0.9em;
        color: #6c757d;
      }

      .compact-values {
        font-size: 0.85em;
        color: #495057;
      }

      /* Popup and sidebar styles reused from provided page */
      .popup {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 1200;
      }

      .popup.error {
        background-color: #dc3545;
      }
    </style>

    <script>
      let userDataMap = {}; // Store the fetched data
      let gptSummaryMap = {}; // Store the GPT summaries

      // Fetch stats from /stats/summary and display them
      function fetchUserStats() {
        fetch("/stats/summary")
          .then((response) => response.json())
          .then((data) => {
            // Store user data in the map
            userDataMap = data.reduce((acc, user) => {
              acc[user.userID] = user;
              return acc;
            }, {});

            // Display the users and their stats immediately
            displayUsers(data);

            // Automatically forward data to /stats/summary_gpt after displaying stats
            fetchGptSummaries(data);
          })
          .catch((error) => console.error("Error fetching user stats:", error));
      }

      // Display users and their basic stats
      function displayUsers(users) {
        const usersTable = document.getElementById("usersTable");
        usersTable.innerHTML = "";
        users.forEach((user) => {
          const totalPoints = user.stats
            ? user.stats.reduce((sum, stat) => sum + stat.values.length, 0)
            : 0;

          const row = `
        <tr>
          <td>${user.userName}</td>
          <td>${totalPoints}</td>
          <td>
            <a href="#" class="expand-btn" onclick="expandUser('${user.userID}')">⬇️</a>
          </td>
        </tr>
      `;
          usersTable.insertAdjacentHTML("beforeend", row);
        });
      }
      // Automatically forward data to /stats/summary_gpt for additional summaries
      function fetchGptSummaries(users) {
        fetch("/stats/summary_gpt", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(users),
        })
          .then((response) => response.json())
          .then((gptData) => {
            // Store GPT summaries in the map for easy lookup
            gptData.forEach((item) => {
              const { userID, pointTypeID, summary } = item;
              if (!gptSummaryMap[userID]) {
                gptSummaryMap[userID] = {};
              }
              gptSummaryMap[userID][pointTypeID] = summary;
            });

            // Check if a user is currently expanded, and refresh its details
            const userDetailsSection = document.getElementById("userDetails");
            if (userDetailsSection && userDetailsSection.dataset.userId) {
              const expandedUserId = userDetailsSection.dataset.userId;
              expandUser(expandedUserId); // Re-expand the same user to refresh the content
            }

            console.log("GPT summaries loaded:", gptSummaryMap);
          })
          .catch((error) =>
            console.error("Error fetching GPT summaries:", error)
          );
      }

      // Expand user details and display stats, including GPT summaries if available
      function expandUser(userID) {
        const userDetailsSection = document.getElementById("userDetails");
        userDetailsSection.innerHTML = ""; // Clear existing details
        userDetailsSection.dataset.userId = userID; // Store the expanded user ID for later refresh
        const user = userDataMap[userID];

        if (!user || !user.stats || user.stats.length === 0) {
          userDetailsSection.innerHTML = `<p>No stats available for ${user.userName}.</p>`;
          return;
        }

        user.stats.forEach((stat) => {
          const pointTypeName = stat.pointTypeName;
          const pointTypeID = stat.pointTypeID;

          // Sort values by timestamp in descending order (newest first)
          const sortedValues = stat.values.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );

          const pointValues = sortedValues.map((value) => value.pointValue);
          const avgValue = (
            pointValues.reduce((acc, value) => acc + value, 0) /
            pointValues.length
          ).toFixed(2);
          const minValue = Math.min(...pointValues).toFixed(2);
          const maxValue = Math.max(...pointValues).toFixed(2);
          const count = pointValues.length;

          // Create a compact, comma-separated list of values
          const valuesList = pointValues
            .map((value) => value.toFixed(2))
            .join(", ");

          // Get the summary from GPT if available
          const gptSummary = gptSummaryMap[userID]?.[pointTypeID] || "";

          const statsRow = `
      <div class="stats-summary">
        <div class="points-section">${pointTypeName}</div>
        <p class="compact-values">${valuesList}</p>
        <p>Count: ${count} | Min: ${minValue} | Max: ${maxValue} | Avg: ${avgValue}</p>
        ${gptSummary ? `<p><strong>Summary:</strong> ${gptSummary}</p>` : ""}
      </div>
    `;
          userDetailsSection.insertAdjacentHTML("beforeend", statsRow);
        });
      }

      // Fetch user stats on page load
      window.onload = fetchUserStats;
    </script>
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Tenbounce</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item">
            <a class="nav-link" href="/stats_summary">Stats</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container my-5">
      <h1>User Stats Summary</h1>

      <table class="table table-bordered user-stats-table">
        <thead>
          <tr>
            <th>User Name</th>
            <th>Total Points</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="usersTable">
          <!-- User rows will be populated here -->
        </tbody>
      </table>

      <div id="userDetails" class="user-details">
        <!-- Expanded user stats will be displayed here -->
      </div>
    </div>

    <div id="popup" class="popup"></div>

    <!-- Bootstrap JS and dependencies -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js"
      integrity="sha512-TPh2Oxlg1zp+kz3nFA0C5vVC6leG/6mm1z9+mA81MI5eaUVqasPLO8Cuk4gMF4gUfP5etR73rgU/8PNMsSesoQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-QhhUxRWxbUHZ2elofMvB51Bo+sXSCZKPpgoeVOzQEDsnEr/efpp1iz15ZLtJwH28"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
